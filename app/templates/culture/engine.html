{% extends "layout.html" %}

{% block title %}æ–‡åŒ–å¼•æ“ - çŸ³æ¦´ç±½å®¶å›­{% endblock %}

{% block head %}
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.iconify.design/3/3.1.1/iconify.min.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    /* D3.jså›¾è°±æ ·å¼ */
    #graphContainer {
      position: relative;
      background-color: #f8fafc;
      border-radius: 0.5rem;
      overflow: hidden;
    }
    .node circle {
      cursor: pointer;
      stroke: #333;
      stroke-width: 1.5px;
    }
    .node text {
      font-size: 12px;
      pointer-events: none;
      text-anchor: middle;
      background-color: white;
      padding: 2px 4px;
      border-radius: 3px;
    }
    .link {
      stroke: #999;
      stroke-opacity: 0.6;
      stroke-width: 1.5px;
    }
    .node.highlight circle {
      stroke: #e74c3c;
      stroke-width: 3px;
      r: 20;
    }
    .node.highlight text {
      font-weight: bold;
      font-size: 14px;
    }
    .link.highlight {
      stroke: #e74c3c;
      stroke-opacity: 1;
      stroke-width: 3px;
    }
    .tooltip {
      position: absolute;
      text-align: center;
      width: auto;
      height: auto;
      padding: 8px 12px;
      font: 12px sans-serif;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #ddd;
      border-radius: 4px;
      pointer-events: none;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      z-index: 1000;
    }
  </style>
  <script>
    function previewImage(input) {
      const file = input.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const previewImg = document.getElementById('preview-img');
          const previewContainer = document.getElementById('image-preview');
          previewImg.src = e.target.result;
          previewContainer.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      }
    }

    function handleDrop(event) {
      event.preventDefault();
      const files = event.dataTransfer.files;
      if (files.length > 0) {
        const fileInput = document.getElementById('image');
        fileInput.files = files;
        previewImage(fileInput);
      }
    }
    
    // çº¹æ ·å›¾ç‰‡é¢„è§ˆåŠŸèƒ½
    function previewPatternImage(input) {
      const file = input.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const previewImg = document.getElementById('pattern-img');
          const previewContainer = document.getElementById('pattern-preview');
          previewImg.src = e.target.result;
          previewContainer.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      }
    }
    
    // çº¹æ ·æ‹–æ”¾å¤„ç†
    function handlePatternDrop(event) {
      event.preventDefault();
      const files = event.dataTransfer.files;
      if (files.length > 0) {
        const fileInput = document.getElementById('pattern-image');
        fileInput.files = files;
        previewPatternImage(fileInput);
      }
    }
    
    // çº¹æ ·è¯†åˆ«ç›¸å…³åŠŸèƒ½
    document.addEventListener('DOMContentLoaded', function() {
      // ç½®ä¿¡åº¦é˜ˆå€¼æ»‘å—å¤„ç†
      const thresholdSlider = document.getElementById('confidence-threshold');
      const thresholdValue = document.getElementById('threshold-value');
      if (thresholdSlider && thresholdValue) {
        thresholdSlider.addEventListener('input', function() {
          thresholdValue.textContent = this.value;
        });
      }
      
      // çº¹æ ·è¯†åˆ«æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      const recognizeBtn = document.getElementById('recognize-pattern-btn');
      if (recognizeBtn) {
        recognizeBtn.addEventListener('click', function() {
          recognizePattern();
        });
      }
    });
    
    // çº¹æ ·è¯†åˆ«åŠŸèƒ½
    async function recognizePattern() {
      const patternImage = document.getElementById('pattern-image').files[0];
      if (!patternImage) {
        showError('è¯·å…ˆä¸Šä¼ çº¹æ ·å›¾ç‰‡');
        return;
      }
      
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      const recognizeBtn = document.getElementById('recognize-pattern-btn');
      const originalBtnText = recognizeBtn.innerHTML;
      recognizeBtn.innerHTML = '<span class="animate-spin mr-2">â³</span> è¯†åˆ«ä¸­...';
      recognizeBtn.disabled = true;
      
      // è·å–è¯†åˆ«è®¾ç½®
      const confidenceThreshold = document.getElementById('confidence-threshold').value;
      const similarityAnalysis = document.getElementById('similarity-analysis').checked;
      const featureExtraction = document.getElementById('feature-extraction').checked;
      const resultCount = document.getElementById('result-count').value;
      const patternCategory = document.getElementById('pattern-category').value;
      const patternDatabase = document.getElementById('pattern-database').value;
      
      try {
        // è¯»å–å›¾ç‰‡æ–‡ä»¶
        const reader = new FileReader();
        const imageDataUrl = await new Promise((resolve) => {
          reader.onload = (e) => resolve(e.target.result);
          reader.readAsDataURL(patternImage);
        });
        
        // æ„å»ºè¯·æ±‚æ•°æ®
        const requestData = {
          input_image: imageDataUrl,
          recognition_score: parseFloat(confidenceThreshold),
          features: featureExtraction,
          similarity_matrix: similarityAnalysis,
          category: patternCategory,
          database: patternDatabase,
          limit: parseInt(resultCount)
        };
        
        // å‘é€è¯†åˆ«è¯·æ±‚
        const response = await fetch('/api/culture/recognize-pattern', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestData)
        });
        
        const result = await response.json();
        
        if (result.success) {
          // æ˜¾ç¤ºè¯†åˆ«ç»“æœ
          displayRecognitionResults(result.data);
        } else {
          showError('çº¹æ ·è¯†åˆ«å¤±è´¥', result.message);
        }
      } catch (error) {
        console.error('çº¹æ ·è¯†åˆ«é”™è¯¯:', error);
        showError('çº¹æ ·è¯†åˆ«å¤±è´¥', error.message);
      } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        recognizeBtn.innerHTML = originalBtnText;
        recognizeBtn.disabled = false;
      }
    }
    
    // æ˜¾ç¤ºè¯†åˆ«ç»“æœ
    function displayRecognitionResults(results) {
      const resultsContainer = document.getElementById('recognition-results');
      
      if (!results || results.length === 0) {
        resultsContainer.innerHTML = `
          <div class="text-center text-gray-500 py-12">
            <div class="text-4xl mb-4">âŒ</div>
            <p>æœªè¯†åˆ«åˆ°ç›¸ä¼¼çº¹æ ·</p>
          </div>
        `;
        return;
      }
      
      // æ·»åŠ å¯è§†åŒ–åˆ†æåŒºåŸŸ
      let resultsHtml = `
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
          <h5 class="font-medium text-[#2C3E50] mb-4">çº¹æ ·åˆ†ææ¦‚è§ˆ</h5>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- ç›¸ä¼¼åº¦çŸ©é˜µå¯è§†åŒ– -->
            <div>
              <h6 class="text-sm font-medium text-[#2C3E50] mb-2">ç›¸ä¼¼åº¦çŸ©é˜µ</h6>
              <div id="similarity-matrix" class="bg-gray-50 p-4 rounded-lg h-48 flex items-center justify-center">
                ${results[0].similarity_matrix ? `
                  <canvas id="similarity-canvas" width="300" height="300"></canvas>
                ` : `
                  <div class="text-gray-500">
                    <div class="text-2xl mb-2">ğŸ“Š</div>
                    <p>ç›¸ä¼¼åº¦çŸ©é˜µä¸å¯ç”¨</p>
                  </div>
                `}
              </div>
            </div>
            
            <!-- ç‰¹å¾åˆ†å¸ƒå¯è§†åŒ– -->
            <div>
              <h6 class="text-sm font-medium text-[#2C3E50] mb-2">ç‰¹å¾åˆ†å¸ƒ</h6>
              <div id="feature-distribution" class="bg-gray-50 p-4 rounded-lg h-48 flex items-center justify-center">
                ${results[0].features ? `
                  <canvas id="feature-canvas" width="300" height="300"></canvas>
                ` : `
                  <div class="text-gray-500">
                    <div class="text-2xl mb-2">ğŸ“ˆ</div>
                    <p>ç‰¹å¾åˆ†å¸ƒä¸å¯ç”¨</p>
                  </div>
                `}
              </div>
            </div>
          </div>
        </div>
      `;
      
      // æ„å»ºç»“æœHTML
      results.forEach((result, index) => {
        resultsHtml += `
          <div class="bg-white rounded-lg shadow-md p-4">
            <div class="flex items-center justify-between mb-3">
              <h5 class="font-medium text-[#2C3E50]">${result.pattern_name || `çº¹æ · ${index + 1}`}</h5>
              <div class="flex items-center">
                <span class="text-sm text-gray-600 mr-2">ç›¸ä¼¼åº¦:</span>
                <div class="w-20 bg-gray-200 rounded-full h-2.5">
                  <div class="bg-[#27AE60] h-2.5 rounded-full" style="width: ${(result.similarity || 0) * 100}%"></div>
                </div>
                <span class="text-sm font-medium text-[#27AE60] ml-2">${((result.similarity || 0) * 100).toFixed(1)}%</span>
              </div>
            </div>
            <div class="grid grid-cols-3 gap-3">
              <div class="col-span-1">
                <img src="${result.pattern_image || 'https://via.placeholder.com/100'}" class="w-full h-24 object-cover rounded-lg shadow-sm" alt="çº¹æ ·">
              </div>
              <div class="col-span-2">
                <p class="text-sm text-gray-600 mb-2">${result.description || 'æš‚æ— æè¿°'}</p>
                <div class="flex flex-wrap gap-2">
                  ${result.tags ? result.tags.map(tag => `<span class="bg-[#E74C3C] text-white text-xs px-2 py-1 rounded-full">${tag}</span>`).join('') : ''}
                </div>
              </div>
            </div>
            ${result.features ? `
              <div class="mt-3">
                <h6 class="text-sm font-medium text-[#2C3E50] mb-2">çº¹æ ·ç‰¹å¾</h6>
                <div class="grid grid-cols-2 gap-2 text-sm">
                  ${Object.entries(result.features).map(([key, value]) => `<div class="flex justify-between"><span class="text-gray-600">${key}:</span><span class="font-medium">${value}</span></div>`).join('')}
                </div>
              </div>
            ` : ''}
            
            <!-- ç›¸ä¼¼çº¹æ ·æ¨è -->
            ${result.similar_patterns ? `
              <div class="mt-4">
                <h6 class="text-sm font-medium text-[#2C3E50] mb-2">ç›¸ä¼¼çº¹æ ·æ¨è</h6>
                <div class="flex overflow-x-auto gap-3 pb-2">
                  ${result.similar_patterns.map(similar => `
                    <div class="flex-shrink-0 w-20 text-center">
                      <img src="${similar.image || 'https://via.placeholder.com/80'}" class="w-16 h-16 object-cover rounded-md shadow-sm mx-auto mb-1" alt="ç›¸ä¼¼çº¹æ ·">
                      <p class="text-xs text-gray-600">${similar.name || 'æœªçŸ¥'}</p>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}
          </div>
        `;
      });
      
      resultsContainer.innerHTML = resultsHtml;
      
      // ç»˜åˆ¶ç›¸ä¼¼åº¦çŸ©é˜µ
      drawSimilarityMatrix(results[0].similarity_matrix);
      
      // ç»˜åˆ¶ç‰¹å¾åˆ†å¸ƒ
      drawFeatureDistribution(results[0].features);
    }
    
    // ç»˜åˆ¶ç›¸ä¼¼åº¦çŸ©é˜µ
    function drawSimilarityMatrix(similarityMatrix) {
      if (!similarityMatrix) return;
      
      const canvas = document.getElementById('similarity-canvas');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      const width = canvas.width;
      const height = canvas.height;
      
      // æ¸…ç©ºç”»å¸ƒ
      ctx.clearRect(0, 0, width, height);
      
      // ç®€åŒ–å¤„ç†ï¼Œå‡è®¾æ˜¯5x5çŸ©é˜µ
      const matrix = similarityMatrix.slice(0, 25).map(v => Math.min(Math.max(v, 0), 1));
      const size = 5;
      const cellSize = Math.min(width, height) / (size + 1);
      const offset = cellSize / 2;
      
      // ç»˜åˆ¶çŸ©é˜µ
      for (let i = 0; i < size; i++) {
        for (let j = 0; j < size; j++) {
          const value = matrix[i * size + j];
          const x = j * cellSize + offset;
          const y = i * cellSize + offset;
          
          // ç»˜åˆ¶å•å…ƒæ ¼
          ctx.fillStyle = `rgba(39, 174, 96, ${value})`;
          ctx.fillRect(x, y, cellSize - 2, cellSize - 2);
          
          // ç»˜åˆ¶æ•°å€¼
          ctx.fillStyle = value > 0.5 ? '#ffffff' : '#000000';
          ctx.font = '10px Arial';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(value.toFixed(2), x + (cellSize - 2) / 2, y + (cellSize - 2) / 2);
        }
      }
    }
    
    // ç»˜åˆ¶ç‰¹å¾åˆ†å¸ƒ
    function drawFeatureDistribution(features) {
      if (!features) return;
      
      const canvas = document.getElementById('feature-canvas');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      const width = canvas.width;
      const height = canvas.height;
      
      // æ¸…ç©ºç”»å¸ƒ
      ctx.clearRect(0, 0, width, height);
      
      // æå–ç‰¹å¾å€¼
      const featureValues = Object.values(features).slice(0, 8).map(v => {
        if (typeof v === 'number') return Math.min(Math.max(v, 0), 1);
        return 0;
      });
      
      const featureNames = Object.keys(features).slice(0, 8);
      const barWidth = width / (featureValues.length * 2);
      const maxValue = Math.max(...featureValues);
      
      // ç»˜åˆ¶æŸ±çŠ¶å›¾
      featureValues.forEach((value, index) => {
        const x = index * barWidth * 2 + barWidth / 2;
        const barHeight = (value / maxValue) * (height - 40);
        const y = height - 30 - barHeight;
        
        // ç»˜åˆ¶æŸ±å­
        ctx.fillStyle = '#3498DB';
        ctx.fillRect(x, y, barWidth, barHeight);
        
        // ç»˜åˆ¶ç‰¹å¾åç§°
        ctx.fillStyle = '#2C3E50';
        ctx.font = '10px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'top';
        ctx.fillText(featureNames[index] || `ç‰¹å¾${index + 1}`, x + barWidth / 2, height - 25);
        
        // ç»˜åˆ¶æ•°å€¼
        ctx.fillStyle = '#27AE60';
        ctx.font = '10px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'bottom';
        ctx.fillText(value.toFixed(2), x + barWidth / 2, y - 5);
      });
    }
  </script>
{% endblock %}

{% block content %}
<section class="py-12 bg-[#FDEDEC]">
  <div class="container mx-auto px-4">
    <div class="text-center mb-12">
      <h2 class="text-4xl font-serif text-[#2C3E50] mb-4">æ–‡åŒ–å¼•æ“</h2>
      <p class="text-xl text-gray-600 max-w-3xl mx-auto">æ¢ç´¢ä¸­åæ°‘æ—å¤šå…ƒæ–‡åŒ–ï¼Œç”Ÿæˆä¸“å±æ–‡åŒ–çŸ¥è¯†å›¾è°±</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8">
      <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
      <div class="lg:col-span-1 order-2 lg:order-1">
        <div class="bg-white rounded-2xl shadow-xl p-4 md:p-6">
          <h3 class="text-xl font-semibold text-[#E74C3C] mb-4">ç”Ÿæˆå›¾è°±</h3>
          <form method="POST" action="/culture/engine">
            {{ form.hidden_tag() }}
            
            <!-- å…³é”®è¯è¾“å…¥ -->
            <div class="mb-6 relative">
              <label class="block text-gray-700 font-medium mb-2" for="keyword">æ–‡åŒ–å…³é”®è¯</label>
              {{ form.keyword(class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#E74C3C]", placeholder="ä¾‹å¦‚: èŒ¶ã€æ˜¥èŠ‚ã€ä¹¦æ³•", id="keyword") }}
              <!-- æœç´¢å»ºè®®ä¸‹æ‹‰æ¡† -->
              <div id="search-suggestions" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden"></div>
            </div>

            <!-- æ°‘æ—é€‰æ‹© -->
            <div class="mb-6">
              <label class="block text-gray-700 font-medium mb-2" for="ethnic_group">æ°‘æ—é€‰æ‹©</label>
              {{ form.ethnic_group(class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#E74C3C]") }}
            </div>

            <!-- æ–‡åŒ–ç±»å‹é€‰æ‹© -->
            <div class="mb-6">
              <label class="block text-gray-700 font-medium mb-2" for="culture_type">æ–‡åŒ–ç±»å‹</label>
              {{ form.culture_type(class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#E74C3C]") }}
            </div>

            <!-- æ–‡åŒ–å†…æ¶µé€‰æ‹© -->
            <div class="mb-6">
              <label class="block text-gray-700 font-medium mb-2" for="aspect">æ–‡åŒ–å†…æ¶µ</label>
              {{ form.aspect(class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#E74C3C]") }}
            </div>

            <!-- å›¾è°±å¸ƒå±€é€‰æ‹© -->
            <div class="mb-6">
              <label class="block text-gray-700 font-medium mb-2" for="layout">å›¾è°±å¸ƒå±€</label>
              {{ form.layout(class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#E74C3C]") }}
            </div>

            <!-- é«˜çº§é€‰é¡¹ -->
            <div class="mb-6">
              <details class="group">
                <summary class="flex items-center justify-between cursor-pointer">
                  <span class="text-gray-700 font-medium">é«˜çº§é€‰é¡¹</span>
                  <span class="iconify group-open:rotate-180 transition-transform" data-icon="mdi:chevron-down"></span>
                </summary>
                <div class="mt-4 space-y-4">
                  <!-- èŠ‚ç‚¹å¤§å°è°ƒæ•´ -->
                  <div>
                    <label class="block text-gray-600 text-sm mb-2" for="node_size">èŠ‚ç‚¹å¤§å°</label>
                    <input type="range" id="node_size" min="30" max="100" value="50" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-[#E74C3C]">
                  </div>
                  
                  <!-- èŠ‚ç‚¹é—´è·è°ƒæ•´ -->
                  <div>
                    <label class="block text-gray-600 text-sm mb-2" for="node_spacing">èŠ‚ç‚¹é—´è·</label>
                    <input type="range" id="node_spacing" min="100" max="300" value="150" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-[#E74C3C]">
                  </div>
                </div>
              </details>
            </div>

            <!-- ç”ŸæˆæŒ‰é’® -->
            <button type="submit" class="w-full bg-gradient-to-r from-[#E74C3C] to-[#F39C12] text-white py-3 rounded-lg hover:shadow-lg transition" title="ç”Ÿæˆæ–‡åŒ–çŸ¥è¯†å›¾è°±">
              ç”Ÿæˆæ–‡åŒ–çŸ¥è¯†å›¾è°±
            </button>
          </form>

          <!-- ä¿å­˜/å¯¼å‡ºåŠŸèƒ½ -->
          <div class="mt-6 pt-6 border-t">
            <h4 class="text-lg font-semibold text-[#2C3E50] mb-4">å›¾è°±ç®¡ç†</h4>
            <div class="grid grid-cols-2 gap-4">
              <button id="save-graph" class="bg-[#3498DB] text-white py-2 rounded-lg hover:bg-[#2980B9] transition flex items-center justify-center" title="ä¿å­˜å½“å‰å›¾è°±">
                <span class="iconify mr-1" data-icon="mdi:content-save"></span>
                ä¿å­˜å›¾è°±
              </button>
              <button id="export-pdf" class="bg-[#27AE60] text-white py-2 rounded-lg hover:bg-[#229954] transition flex items-center justify-center" title="å¯¼å‡ºä¸ºPDF">
                <span class="iconify mr-1" data-icon="mdi:file-pdf-box"></span>
                å¯¼å‡ºPDF
              </button>
            </div>
            
            <!-- æ¸…é™¤é«˜äº®æŒ‰é’® -->
            <button id="clear-highlight" class="mt-4 w-full bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300 transition flex items-center justify-center" title="æ¸…é™¤æ‰€æœ‰é«˜äº®">
              <span class="iconify mr-1" data-icon="mdi:format-color-reset"></span>
              æ¸…é™¤é«˜äº®
            </button>
          </div>
          
          <!-- å›¾ä¾‹ -->
          <div class="mt-6 pt-6 border-t">
            <h4 class="text-lg font-semibold text-[#2C3E50] mb-4">å›¾ä¾‹è¯´æ˜</h4>
            <div class="space-y-2">
              <div class="flex items-center">
                <div class="w-4 h-4 rounded-full bg-[#e74c3c] mr-2"></div>
                <span class="text-gray-700">ä¸­å¿ƒä¸»é¢˜</span>
              </div>
              <div class="flex items-center">
                <div class="w-4 h-4 rounded-full bg-[#3498db] mr-2"></div>
                <span class="text-gray-700">æ°‘æ—æ–‡åŒ–</span>
              </div>
              <div class="flex items-center">
                <div class="w-4 h-4 rounded-full bg-[#2ecc71] mr-2"></div>
                <span class="text-gray-700">æ–‡åŒ–å†…æ¶µ</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- å³ä¾§å›¾è°±å±•ç¤ºåŒº -->
      <div class="lg:col-span-2 order-1 lg:order-2">
        <div class="bg-white rounded-2xl shadow-xl p-4 md:p-6">
          <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-3">
            <h3 class="text-xl font-semibold text-[#E74C3C]">æ–‡åŒ–çŸ¥è¯†å›¾è°±</h3>
            <div class="flex flex-wrap gap-2 items-center w-full md:w-auto">
              <!-- æ–°å¢ï¼šæœç´¢æ¡† -->
              <input type="text" id="graph-search" placeholder="æœç´¢æ–‡åŒ–å…ƒç´ /æ°‘æ—/æ–‡åŒ–å†…æ¶µï¼ˆä¾‹ï¼šèŒ¶ã€æ±‰æ—ã€å†å²æ¸Šæºï¼‰" 
                     class="w-full md:w-auto flex-1 md:flex-initial px-2 py-1.5 md:px-3 md:py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-[#E74C3C] focus:border-transparent" 
                     style="min-width: 0; max-width: 300px;">
              <button id="reset-view" class="bg-gray-200 text-gray-700 px-2 py-1.5 md:px-3 md:py-2 rounded-lg hover:bg-gray-300 transition flex items-center text-sm" title="é‡ç½®è§†å›¾">
                <span class="iconify mr-1" data-icon="mdi:refresh"></span>
                é‡ç½®
              </button>
              <button id="fullscreen" class="bg-gray-200 text-gray-700 px-2 py-1.5 md:px-3 md:py-2 rounded-lg hover:bg-gray-300 transition flex items-center text-sm" title="å…¨å±æŸ¥çœ‹">
                <span class="iconify mr-1" data-icon="mdi:fullscreen"></span>
                å…¨å±
              </button>
            </div>
          </div>
          
          <!-- D3.jså›¾è°±å®¹å™¨ -->
              <div id="graphContainer" class="w-full h-[300px] md:h-[500px] lg:h-[600px] bg-gray-50 rounded-xl"></div>
          
          <!-- åŠ è½½å±‚ -->
          <div id="graphLoading" class="absolute inset-0 bg-white bg-opacity-70 flex items-center justify-center z-10" style="display: none;">
            <div class="text-center">
              <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-[#E74C3C] border-b-4 border-[#F39C12] mx-auto mb-4"></div>
              <p class="text-lg text-[#2C3E50]">æ­£åœ¨ç”Ÿæˆå›¾è°±...</p>
              <p class="text-gray-600 mt-2">è¯·ç¨å€™ï¼Œç²¾å½©å³å°†å‘ˆç°</p>
            </div>
          </div>
        </div>

        <!-- åº•éƒ¨æ–‡åŒ–æ¨è -->
        <div class="mt-8 bg-white rounded-2xl shadow-xl p-6">
          <h3 class="text-xl font-semibold text-[#E74C3C] mb-4">æ–‡åŒ–æ¨è</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-gray-50 p-4 rounded-xl hover:shadow-md transition cursor-pointer">
              <div class="text-[#3498DB] text-3xl mb-2">ğŸ“š</div>
              <h4 class="font-medium text-[#2C3E50] mb-1">æ–‡åŒ–ç™¾ç§‘</h4>
              <p class="text-sm text-gray-600">æ·±å…¥äº†è§£ä¸­åæ°‘æ—æ–‡åŒ–å†…æ¶µ</p>
            </div>
            <div class="bg-gray-50 p-4 rounded-xl hover:shadow-md transition cursor-pointer">
              <div class="text-[#27AE60] text-3xl mb-2">ğŸ­</div>
              <h4 class="font-medium text-[#2C3E50] mb-1">æ°‘æ—è‰ºæœ¯</h4>
              <p class="text-sm text-gray-600">æ¬£èµå„æ°‘æ—ä¼ ç»Ÿè‰ºæœ¯è¡¨æ¼”</p>
            </div>
            <div class="bg-gray-50 p-4 rounded-xl hover:shadow-md transition cursor-pointer">
              <div class="text-[#F39C12] text-3xl mb-2">ğŸ—ºï¸</div>
              <h4 class="font-medium text-[#2C3E50] mb-1">æ–‡åŒ–åœ°å›¾</h4>
              <p class="text-sm text-gray-600">æ¢ç´¢ä¸­åæ–‡åŒ–åœ°ç†åˆ†å¸ƒ</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- çº¹æ ·è¯†åˆ«åŠŸèƒ½åŒº -->
    <div class="mt-8">
      <div class="bg-white rounded-2xl shadow-xl p-6">
        <h3 class="text-xl font-semibold text-[#E74C3C] mb-4 text-center">æ–‡åŒ–çº¹æ ·è¯†åˆ«</h3>
        <div class="grid grid-cols-1 md:grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8">
          <!-- çº¹æ ·ä¸Šä¼  -->
          <div>
            <h4 class="text-lg font-medium text-[#2C3E50] mb-4">ä¸Šä¼ çº¹æ ·</h4>
            <div class="bg-gray-100 rounded-xl p-4 h-[400px] flex flex-col items-center justify-center">
              <div id="pattern-preview" class="hidden mb-4">
                <img id="pattern-img" class="max-w-full max-h-60 rounded-lg shadow-lg" alt="çº¹æ ·é¢„è§ˆå›¾">
              </div>
              <div id="pattern-drop-area" class="border-2 border-dashed border-[#3498DB] rounded-xl p-8 text-center w-full" ondrop="handlePatternDrop(event)" ondragover="event.preventDefault()">
                <div class="text-[#3498DB] text-6xl mb-4">ğŸ¨</div>
                <h5 class="text-xl font-medium mb-2">æ‹–æ”¾çº¹æ ·å›¾ç‰‡åˆ°æ­¤å¤„</h5>
                <p class="text-gray-600 mb-4">æˆ–</p>
                <label for="pattern-image" class="bg-gradient-to-r from-[#3498DB] to-[#2980B9] text-white px-6 py-3 rounded-lg inline-block cursor-pointer hover:shadow-lg transition">
                  é€‰æ‹©çº¹æ ·å›¾ç‰‡
                  <input type="file" id="pattern-image" class="hidden" onchange="previewPatternImage(this)">
                </label>
                <p class="text-sm text-gray-500 mt-4">æ”¯æŒ JPGã€PNG æ ¼å¼ï¼Œå»ºè®®å°ºå¯¸ 512x512px</p>
              </div>
              <div class="mt-6 w-full">
                <label class="block text-gray-700 font-medium mb-2" for="pattern-category">çº¹æ ·ç±»åˆ«</label>
                <select id="pattern-category" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#E74C3C]">
                  <option value="">æ‰€æœ‰ç±»åˆ«</option>
                  <option value="èŠ±å‰">èŠ±å‰çº¹æ ·</option>
                  <option value="å‡ ä½•">å‡ ä½•çº¹æ ·</option>
                  <option value="åŠ¨ç‰©">åŠ¨ç‰©çº¹æ ·</option>
                  <option value="æ–‡å­—">æ–‡å­—çº¹æ ·</option>
                  <option value="è‡ªç„¶">è‡ªç„¶çº¹æ ·</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- è¯†åˆ«è®¾ç½® -->
          <div>
            <h4 class="text-lg font-medium text-[#2C3E50] mb-4">è¯†åˆ«è®¾ç½®</h4>
            <div class="bg-gray-100 rounded-xl p-4 h-[400px] flex flex-col">
              <div class="space-y-6">
                <div>
                  <label class="block text-gray-700 font-medium mb-2">è¯†åˆ«ç½®ä¿¡åº¦é˜ˆå€¼</label>
                  <input type="range" id="confidence-threshold" min="0.1" max="1.0" step="0.1" value="0.7" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-[#E74C3C]">
                  <div class="flex justify-between text-sm text-gray-600 mt-1">
                    <span>0.1</span>
                    <span id="threshold-value">0.7</span>
                    <span>1.0</span>
                  </div>
                </div>
                
                <div>
                  <label class="block text-gray-700 font-medium mb-2">ç›¸ä¼¼åº¦åˆ†æ</label>
                  <div class="space-y-2">
                    <label class="flex items-center">
                      <input type="checkbox" id="similarity-analysis" checked class="w-4 h-4 text-[#E74C3C] rounded focus:ring-[#E74C3C]">
                      <span class="ml-2 text-gray-700">å¯ç”¨ç›¸ä¼¼åº¦åˆ†æ</span>
                    </label>
                    <label class="flex items-center">
                      <input type="checkbox" id="feature-extraction" checked class="w-4 h-4 text-[#E74C3C] rounded focus:ring-[#E74C3C]">
                      <span class="ml-2 text-gray-700">æå–çº¹æ ·ç‰¹å¾</span>
                    </label>
                  </div>
                </div>
                
                <div>
                  <label class="block text-gray-700 font-medium mb-2">è¿”å›ç»“æœæ•°é‡</label>
                  <select id="result-count" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#E74C3C]">
                    <option value="3">3ä¸ªç»“æœ</option>
                    <option value="5" selected>5ä¸ªç»“æœ</option>
                    <option value="10">10ä¸ªç»“æœ</option>
                  </select>
                </div>
                
                <div>
                  <label class="block text-gray-700 font-medium mb-2">çº¹æ ·æ•°æ®åº“</label>
                  <select id="pattern-database" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#E74C3C]">
                    <option value="all" selected>æ‰€æœ‰æ•°æ®åº“</option>
                    <option value="traditional">ä¼ ç»Ÿçº¹æ ·åº“</option>
                    <option value="ethnic">æ°‘æ—çº¹æ ·åº“</option>
                    <option value="modern">ç°ä»£çº¹æ ·åº“</option>
                  </select>
                </div>
              </div>
              
              <div class="mt-auto">
                <button id="recognize-pattern-btn" class="w-full bg-gradient-to-r from-[#E74C3C] to-[#F39C12] text-white py-3 rounded-lg hover:shadow-lg transition" title="å¼€å§‹çº¹æ ·è¯†åˆ«">
                  å¼€å§‹çº¹æ ·è¯†åˆ«
                </button>
              </div>
            </div>
          </div>
          
          <!-- è¯†åˆ«ç»“æœ -->
          <div>
            <h4 class="text-lg font-medium text-[#2C3E50] mb-4">è¯†åˆ«ç»“æœ</h4>
            <div class="bg-gray-100 rounded-xl p-4 h-[400px] overflow-y-auto">
              <div id="recognition-results" class="space-y-4">
                <div class="text-center text-gray-500 py-12">
                  <div class="text-4xl mb-4">ğŸ”</div>
                  <p>ä¸Šä¼ çº¹æ ·å›¾ç‰‡å¹¶ç‚¹å‡»è¯†åˆ«æŒ‰é’®å¼€å§‹åˆ†æ</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- æ–‡åŒ–æµ·æŠ¥ç”ŸæˆåŒº -->
    <div class="mt-8">
      <div class="bg-white rounded-2xl shadow-xl p-6">
        <h3 class="text-xl font-semibold text-[#E74C3C] mb-4 text-center">æ–‡åŒ–èåˆæµ·æŠ¥ç”Ÿæˆ</h3>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <!-- æµ·æŠ¥é¢„è§ˆ -->
          <div>
            <h4 class="text-lg font-medium text-[#2C3E50] mb-4">é¢„è§ˆæ•ˆæœ</h4>
            <div class="bg-gray-100 rounded-xl p-4 h-96 flex items-center justify-center">
              <div id="image-preview" class="hidden">
                <img id="preview-img" class="max-w-full max-h-80 rounded-lg shadow-lg" alt="é¢„è§ˆå›¾">
              </div>
              <div id="drop-area" class="border-2 border-dashed border-[#3498DB] rounded-xl p-8 text-center w-full" ondrop="handleDrop(event)" ondragover="event.preventDefault()">
                <div class="text-[#3498DB] text-6xl mb-4">ğŸ“¸</div>
                <h5 class="text-xl font-medium mb-2">æ‹–æ”¾å›¾ç‰‡åˆ°æ­¤å¤„</h5>
                <p class="text-gray-600 mb-4">æˆ–</p>
                <label for="image" class="bg-gradient-to-r from-[#3498DB] to-[#2980B9] text-white px-6 py-3 rounded-lg inline-block cursor-pointer hover:shadow-lg transition">
                  é€‰æ‹©å›¾ç‰‡
                  <input type="file" id="image" class="hidden" onchange="previewImage(this)">
                </label>
                <p class="text-sm text-gray-500 mt-4">æ”¯æŒ JPGã€PNG æ ¼å¼ï¼Œå»ºè®®å°ºå¯¸ 1080x1080px</p>
              </div>
            </div>
          </div>
          
          <!-- æµ·æŠ¥è®¾ç½® -->
          <div>
            <h4 class="text-lg font-medium text-[#2C3E50] mb-4">æµ·æŠ¥è®¾è®¡</h4>
            <form>
              <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-2" for="poster-title">æµ·æŠ¥æ ‡é¢˜</label>
                <input type="text" id="poster-title" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#E74C3C]" placeholder="ä¾‹å¦‚: ä¸­åæ°‘æ—æ–‡åŒ–èåˆ">
              </div>
              
              <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-2" for="poster-style">æµ·æŠ¥é£æ ¼</label>
                <select id="poster-style" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#E74C3C]">
                  <option value="traditional">ä¼ ç»Ÿé£æ ¼</option>
                  <option value="modern">ç°ä»£é£æ ¼</option>
                  <option value="minimalist">ç®€çº¦é£æ ¼</option>
                  <option value="colorful">å¤šå½©é£æ ¼</option>
                </select>
              </div>
              
              <div class="mb-6">
                <label class="block text-gray-700 font-medium mb-2" for="poster-text">å®£ä¼ è¯­</label>
                <textarea id="poster-text" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#E74C3C]" placeholder="ä¾‹å¦‚: å¤šå…ƒæ–‡åŒ–ï¼Œå’Œè°å…±ç”Ÿ"></textarea>
              </div>
              
              <button type="submit" class="w-full bg-gradient-to-r from-[#E74C3C] to-[#F39C12] text-white py-3 rounded-lg hover:shadow-lg transition" title="ç”Ÿæˆæ°‘æ—èåˆæµ·æŠ¥">
                ç”Ÿæˆæ°‘æ—èåˆæµ·æŠ¥
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
  // æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æç¤º
  function showError(message, details = '') {
    // åˆ›å»ºé”™è¯¯æç¤ºæ¨¡æ€æ¡†
    const errorModal = document.createElement('div');
    errorModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300';
    errorModal.style.opacity = '0';
    errorModal.innerHTML = `
      <div class="bg-white rounded-2xl shadow-xl max-w-md w-full mx-4 overflow-hidden transform transition-transform duration-300 scale-95">
        <div class="bg-red-500 p-4 flex justify-between items-center">
          <h3 class="text-white text-xl font-semibold">é”™è¯¯æç¤º</h3>
          <button class="text-white text-2xl hover:text-gray-200 transition" onclick="this.closest('.fixed').remove()" title="å…³é—­é”™è¯¯æç¤º">&times;</button>
        </div>
        <div class="p-6">
          <div class="flex items-start mb-4">
            <div class="text-red-500 mr-3 mt-1">
              <span class="iconify" data-icon="mdi:alert-circle" data-width="24"></span>
            </div>
            <div>
              <p class="text-gray-700 mb-2">${message}</p>
              ${details ? `<div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-600 mt-2">
                <strong>è¯¦ç»†ä¿¡æ¯:</strong> ${details}
              </div>` : ''}
            </div>
          </div>
          <div class="flex justify-end">
            <button class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition" onclick="this.closest('.fixed').remove()">
              ç¡®å®š
            </button>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(errorModal);
    
    // æ·»åŠ åŠ¨ç”»
    setTimeout(() => {
      errorModal.style.opacity = '1';
      const modalContent = errorModal.querySelector('.bg-white');
      modalContent.classList.remove('scale-95');
      modalContent.classList.add('scale-100');
    }, 10);
  }

  // å…¨å±€å˜é‡å£°æ˜
  let currentSelectedKeyword = 'èŒ¶';
  let currentSelectedEthnic = 'å…¨éƒ¨';
  let currentSelectedCultureType = 'å…¨éƒ¨';
  let currentSelectedAspect = 'å…¨éƒ¨';
  let simulation = null;
  let svg = null;
  let nodes = [];
  let links = [];

  // ä»åç«¯APIè·å–æ–‡åŒ–å›¾è°±æ•°æ®
  async function fetchGraphData(keyword, selectedEthnicGroup, selectedCultureType, selectedAspect) {
    try {
      console.log('ğŸ“¡ å¼€å§‹è·å–å›¾è°±æ•°æ®ï¼Œå…³é”®è¯:', keyword);
      
      // æ„å»ºAPI URL
      const url = new URL('/api/culture/graph', window.location.origin);
      url.searchParams.append('keyword', keyword);
      url.searchParams.append('ethnic_group', selectedEthnicGroup);
      url.searchParams.append('culture_type', selectedCultureType);
      url.searchParams.append('aspect', selectedAspect);
      
      // å‘é€è¯·æ±‚
      const response = await fetch(url);
      
      // æ£€æŸ¥å“åº”çŠ¶æ€
      if (!response.ok) {
        console.error('âŒ APIè¯·æ±‚å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®');
        // è¿”å›é»˜è®¤æ•°æ®
        return {
          central_topic: keyword,
          description: `å…³äº"${keyword}"çš„æ–‡åŒ–çŸ¥è¯†å›¾è°±`,
          ethnic_groups: [
            { name: 'æ±‰æ—', culture: `æ±‰æ—çš„${keyword}æ–‡åŒ–`, customs: `æ±‰æ—å…³äº${keyword}çš„ä¼ ç»Ÿä¹ ä¿—` },
            { name: 'è—æ—', culture: `è—æ—çš„${keyword}æ–‡åŒ–`, customs: `è—æ—å…³äº${keyword}çš„ä¼ ç»Ÿä¹ ä¿—` },
            { name: 'è’™å¤æ—', culture: `è’™å¤æ—çš„${keyword}æ–‡åŒ–`, customs: `è’™å¤æ—å…³äº${keyword}çš„ä¼ ç»Ÿä¹ ä¿—` }
          ],
          historical_origins: `ä¸­åæ°‘æ—å…³äº${keyword}çš„å†å²æ¸Šæº`
        };
      }
      
      // è§£æå“åº”æ•°æ®
      const data = await response.json();
      
      // éªŒè¯æ•°æ®æ ¼å¼
      if (!data || !data.success || !data.data) {
        console.error('âŒ æ•°æ®æ ¼å¼æ— æ•ˆï¼Œä½¿ç”¨é»˜è®¤æ•°æ®');
        // è¿”å›é»˜è®¤æ•°æ®
        return {
          central_topic: keyword,
          description: `å…³äº"${keyword}"çš„æ–‡åŒ–çŸ¥è¯†å›¾è°±`,
          ethnic_groups: [
            { name: 'æ±‰æ—', culture: `æ±‰æ—çš„${keyword}æ–‡åŒ–`, customs: `æ±‰æ—å…³äº${keyword}çš„ä¼ ç»Ÿä¹ ä¿—` },
            { name: 'è—æ—', culture: `è—æ—çš„${keyword}æ–‡åŒ–`, customs: `è—æ—å…³äº${keyword}çš„ä¼ ç»Ÿä¹ ä¿—` },
            { name: 'è’™å¤æ—', culture: `è’™å¤æ—çš„${keyword}æ–‡åŒ–`, customs: `è’™å¤æ—å…³äº${keyword}çš„ä¼ ç»Ÿä¹ ä¿—` }
          ],
          historical_origins: `ä¸­åæ°‘æ—å…³äº${keyword}çš„å†å²æ¸Šæº`
        };
      }
      
      // ç¡®ä¿ethnic_groupsæ˜¯æ•°ç»„
      if (!Array.isArray(data.data.ethnic_groups)) {
        data.data.ethnic_groups = [];
      }
      
      // å¦‚æœæ²¡æœ‰æ°‘æ—æ•°æ®ï¼Œæ·»åŠ é»˜è®¤æ°‘æ—
      if (data.data.ethnic_groups.length === 0) {
        data.data.ethnic_groups = [
          { name: 'æ±‰æ—', culture: `æ±‰æ—çš„${keyword}æ–‡åŒ–`, customs: `æ±‰æ—å…³äº${keyword}çš„ä¼ ç»Ÿä¹ ä¿—` },
          { name: 'è—æ—', culture: `è—æ—çš„${keyword}æ–‡åŒ–`, customs: `è—æ—å…³äº${keyword}çš„ä¼ ç»Ÿä¹ ä¿—` },
          { name: 'è’™å¤æ—', culture: `è’™å¤æ—çš„${keyword}æ–‡åŒ–`, customs: `è’™å¤æ—å…³äº${keyword}çš„ä¼ ç»Ÿä¹ ä¿—` }
        ];
      }
      
      console.log('âœ… æ•°æ®è·å–æˆåŠŸï¼Œå‡†å¤‡è¿”å›æ•°æ®');
      return data.data;
    } catch (error) {
      console.error('ğŸ’¥ è·å–å›¾è°±æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®:', error);
      // è¿”å›é»˜è®¤æ•°æ®
      return {
        central_topic: keyword,
        description: `å…³äº"${keyword}"çš„æ–‡åŒ–çŸ¥è¯†å›¾è°±`,
        ethnic_groups: [
          { name: 'æ±‰æ—', culture: `æ±‰æ—çš„${keyword}æ–‡åŒ–`, customs: `æ±‰æ—å…³äº${keyword}çš„ä¼ ç»Ÿä¹ ä¿—` },
          { name: 'è—æ—', culture: `è—æ—çš„${keyword}æ–‡åŒ–`, customs: `è—æ—å…³äº${keyword}çš„ä¼ ç»Ÿä¹ ä¿—` },
          { name: 'è’™å¤æ—', culture: `è’™å¤æ—çš„${keyword}æ–‡åŒ–`, customs: `è’™å¤æ—å…³äº${keyword}çš„ä¼ ç»Ÿä¹ ä¿—` }
        ],
        historical_origins: `ä¸­åæ°‘æ—å…³äº${keyword}çš„å†å²æ¸Šæº`
      };
    }
  }

  // å°†APIæ•°æ®è½¬æ¢ä¸ºD3.jsæ‰€éœ€çš„æ ¼å¼
  function convertToD3Data(materialData) {
    const d3Nodes = [];
    const d3Links = [];
    
    // èŠ‚ç‚¹é¢œè‰²æ˜ å°„
    const colors = {
      'ä¸­å¿ƒä¸»é¢˜': '#e74c3c',
      'æ°‘æ—æ–‡åŒ–': '#3498db',
      'æ–‡åŒ–å†…æ¶µ': '#2ecc71'
    };
    
    // æ·»åŠ ä¸­å¿ƒä¸»é¢˜èŠ‚ç‚¹
    const centralNode = {
      id: 'central',
      name: materialData.central_topic || 'æ–‡åŒ–',
      type: 'ä¸­å¿ƒä¸»é¢˜',
      description: materialData.description || 'ä¸­åæ°‘æ—å…±åŒçš„æ–‡åŒ–ç¬¦å·',
      color: colors['ä¸­å¿ƒä¸»é¢˜']
    };
    d3Nodes.push(centralNode);
    
    // æ·»åŠ æ–‡åŒ–å†…æ¶µèŠ‚ç‚¹
    const cultureNodes = [
      { id: 'history', name: 'å†å²æ¸Šæº', type: 'æ–‡åŒ–å†…æ¶µ', description: materialData.historical_origins || 'ä¸­åæ°‘æ—ä¼ ç»Ÿå†å²', color: colors['æ–‡åŒ–å†…æ¶µ'] },
      { id: 'etiquette', name: 'ç¤¾äº¤ç¤¼ä»ª', type: 'æ–‡åŒ–å†…æ¶µ', description: 'ä¼ ç»Ÿä¹ ä¿—ä¸ä»ªå¼', color: colors['æ–‡åŒ–å†…æ¶µ'] },
      { id: 'lifestyle', name: 'ç”Ÿæ´»æ–¹å¼', type: 'æ–‡åŒ–å†…æ¶µ', description: 'æ—¥å¸¸åº”ç”¨ä¸å®è·µ', color: colors['æ–‡åŒ–å†…æ¶µ'] },
      { id: 'fusion', name: 'æ–‡åŒ–èåˆ', type: 'æ–‡åŒ–å†…æ¶µ', description: 'ä¿ƒè¿›æ°‘æ—äº¤æµ', color: colors['æ–‡åŒ–å†…æ¶µ'] }
    ];
    d3Nodes.push(...cultureNodes);
    
    // æ·»åŠ æ°‘æ—èŠ‚ç‚¹å¹¶å»ºç«‹å…³ç³»
    materialData.ethnic_groups.forEach((group, index) => {
      const ethnicNode = {
        id: `ethnic_${index}`,
        name: group.name,
        type: 'æ°‘æ—æ–‡åŒ–',
        culture: group.culture,
        customs: group.customs,
        color: colors['æ°‘æ—æ–‡åŒ–']
      };
      d3Nodes.push(ethnicNode);
      
      // ä¸­å¿ƒä¸»é¢˜åˆ°æ°‘æ—çš„å…³ç³»
      d3Links.push({
        source: 'central',
        target: ethnicNode.id,
        relation: `åœ¨${group.name}ä¸­çš„åº”ç”¨`
      });
      
      // æ°‘æ—åˆ°æ–‡åŒ–å†…æ¶µçš„å…³ç³»
      d3Links.push({
        source: ethnicNode.id,
        target: 'etiquette',
        relation: 'ä½“ç°'
      });
      d3Links.push({
        source: ethnicNode.id,
        target: 'lifestyle',
        relation: 'èå…¥'
      });
    });
    
    // ä¸­å¿ƒä¸»é¢˜åˆ°æ–‡åŒ–å†…æ¶µçš„å…³ç³»
    d3Links.push({
      source: 'central',
      target: 'history',
      relation: 'æºäº'
    });
    d3Links.push({
      source: 'central',
      target: 'fusion',
      relation: 'ä¿ƒè¿›'
    });
    
    return { nodes: d3Nodes, links: d3Links };
  }

  // ä½¿ç”¨D3.jsæ¸²æŸ“çŸ¥è¯†å›¾è°±
  async function renderGraph(keyword = 'èŒ¶', selectedEthnicGroup = 'å…¨éƒ¨', selectedCultureType = 'å…¨éƒ¨', selectedAspect = 'å…¨éƒ¨') {
    const container = document.getElementById('graphContainer');
    const loadingOverlay = document.getElementById('graphLoading');
    
    // è·å–é€‰ä¸­çš„å¸ƒå±€ç±»å‹
    const layoutSelect = document.getElementById('layout');
    const layoutType = layoutSelect ? layoutSelect.value : 'force';
    
    // æ˜¾ç¤ºåŠ è½½å±‚ï¼Œæ·»åŠ å¹³æ»‘è¿‡æ¸¡
      if (loadingOverlay) {
        loadingOverlay.style.display = 'flex';
        // ä½¿ç”¨requestAnimationFrameç¡®ä¿å¹³æ»‘è¿‡æ¸¡
        requestAnimationFrame(() => {
          loadingOverlay.style.opacity = '1';
        });
      }
    
    try {
      console.log('å¼€å§‹æ¸²æŸ“D3.jså›¾è°±ï¼Œå…³é”®è¯:', keyword, 'å¸ƒå±€ç±»å‹:', layoutType);
      
      // ä»åç«¯è·å–æ•°æ®
      const materialData = await fetchGraphData(keyword, selectedEthnicGroup, selectedCultureType, selectedAspect);
      
      // è½¬æ¢ä¸ºD3.jsæ‰€éœ€æ ¼å¼
      const d3Data = convertToD3Data(materialData);
      nodes = d3Data.nodes;
      links = d3Data.links;
      
      // æ¸…ç©ºå®¹å™¨
      container.innerHTML = '';
      
      // è®¾ç½®å°ºå¯¸
      const width = container.clientWidth;
      const height = container.clientHeight;
      
      // åˆ›å»ºSVG
      svg = d3.select(container)
        .append('svg')
        .attr('width', width)
        .attr('height', height)
        .call(d3.zoom()
          .scaleExtent([0.1, 3])
          .on('zoom', (event) => {
            g.attr('transform', event.transform);
          }));
      
      // åˆ›å»ºåˆ†ç»„
      const g = svg.append('g');
      
      // æ·»åŠ ç®­å¤´æ ‡è®°å®šä¹‰
      svg.append('defs').selectAll('marker')
        .data(['arrowhead'])
        .enter().append('marker')
        .attr('id', 'arrowhead')
        .attr('viewBox', '0 -5 10 10')
        .attr('refX', 25)
        .attr('refY', 0)
        .attr('markerWidth', 6)
        .attr('markerHeight', 6)
        .attr('orient', 'auto')
        .append('path')
        .attr('d', 'M 0,-5 L 10,0 L 0,5')
        .attr('fill', '#999');
      
      // åˆ›å»ºè¿æ¥çº¿
      const link = g.append('g')
        .selectAll('line')
        .data(links)
        .join('line')
        .attr('class', 'link')
        .attr('stroke', '#999')
        .attr('stroke-opacity', 0)
        .attr('stroke-width', 1.5)
        // æ·»åŠ ç®­å¤´æ ‡è®°
        .attr('marker-end', 'url(#arrowhead)');
      
      // åˆ›å»ºèŠ‚ç‚¹ç»„
      const node = g.append('g')
        .selectAll('.node')
        .data(nodes)
        .join('g')
        .attr('class', 'node')
        .attr('opacity', 0)
        .attr('transform', d => `translate(${width / 2},${height / 2})`);
      
      // åº”ç”¨è¿‡æ¸¡æ•ˆæœ
      node.transition()
        .duration(500)
        .attr('opacity', 1);
      
      // æ·»åŠ èŠ‚ç‚¹åœ†å½¢ï¼Œæ ¹æ®èŠ‚ç‚¹ç±»å‹è°ƒæ•´å¤§å°
      const circle = node.append('circle')
        .attr('r', 0)
        .attr('fill', d => d.color)
        .attr('stroke', '#333')
        .attr('stroke-width', 1.5)
        .on('click', handleNodeClick)
        .on('mouseover', handleMouseOver)
        .on('mouseout', handleMouseOut);
      
      // åŠ¨ç”»æ˜¾ç¤ºèŠ‚ç‚¹
      circle.transition()
        .duration(800)
        .ease(d3.easeElasticOut)
        .attr('r', d => {
          // æ ¹æ®èŠ‚ç‚¹ç±»å‹è°ƒæ•´å¤§å°
          switch (d.type) {
            case 'ä¸­å¿ƒä¸»é¢˜': return 25;
            case 'æ–‡åŒ–å†…æ¶µ': return 20;
            case 'æ°‘æ—æ–‡åŒ–': return 18;
            default: return 15;
          }
        });
      
      // åªæœ‰åœ¨åŠ›å¯¼å‘å¸ƒå±€ä¸‹æ‰æ·»åŠ æ‹–æ‹½åŠŸèƒ½
      if (layoutType === 'force') {
        // å®šä¹‰æ‹–æ‹½å¤„ç†å‡½æ•°
        function dragstarted(event, d) {
          if (!event.active && simulation) simulation.alphaTarget(0.3).restart();
          d.fx = d.x;
          d.fy = d.y;
        }
        
        function dragged(event, d) {
          d.fx = event.x;
          d.fy = event.y;
        }
        
        function dragended(event, d) {
          if (!event.active && simulation) simulation.alphaTarget(0);
          d.fx = null;
          d.fy = null;
        }
        
        // æ·»åŠ æ‹–æ‹½äº‹ä»¶åˆ°åœ†å½¢å…ƒç´ 
        circle.call(d3.drag()
          .on('start', dragstarted)
          .on('drag', dragged)
          .on('end', dragended));
      }
      
      // æ·»åŠ èŠ‚ç‚¹æ–‡æœ¬ï¼Œå®ç°æ™ºèƒ½æ’ç‰ˆ
      node.append('text')
        .text(d => d.name)
        .attr('x', 0)
        .attr('y', d => {
          // æ ¹æ®èŠ‚ç‚¹å¤§å°è°ƒæ•´æ–‡æœ¬ä½ç½®
          switch (d.type) {
            case 'ä¸­å¿ƒä¸»é¢˜': return 35;
            case 'æ–‡åŒ–å†…æ¶µ': return 30;
            case 'æ°‘æ—æ–‡åŒ–': return 28;
            default: return 25;
          }
        })
        .attr('text-anchor', 'middle')
        .attr('font-size', 12)
        .attr('fill', '#333')
        .attr('pointer-events', 'none')
        .attr('dy', '.35em')
        // æ·»åŠ æ–‡æœ¬èƒŒæ™¯
        .each(function(d) {
          const bbox = this.getBBox();
          const padding = 3;
          d3.select(this.parentNode).append('rect')
            .attr('x', bbox.x - padding)
            .attr('y', bbox.y - padding)
            .attr('width', bbox.width + (padding * 2))
            .attr('height', bbox.height + (padding * 2))
            .attr('fill', 'white')
            .attr('opacity', 0.8)
            .attr('rx', 3)
            .attr('ry', 3)
            .lower();
        });
      
      // æ ¹æ®å¸ƒå±€ç±»å‹é€‰æ‹©ä¸åŒçš„å¸ƒå±€ç®—æ³•
      if (layoutType === 'force') {
        // åŠ›å¯¼å‘å¸ƒå±€
        simulation = d3.forceSimulation(nodes)
          .force('link', d3.forceLink(links).id(d => d.id).distance(150))
          .force('charge', d3.forceManyBody().strength(-200))
          .force('center', d3.forceCenter(width / 2, height / 2))
          .force('collision', d3.forceCollide().radius(d => {
            // æ ¹æ®èŠ‚ç‚¹ç±»å‹è°ƒæ•´ç¢°æ’åŠå¾„
            switch (d.type) {
              case 'ä¸­å¿ƒä¸»é¢˜': return 40;
              case 'æ–‡åŒ–å†…æ¶µ': return 30;
              case 'æ°‘æ—æ–‡åŒ–': return 25;
              default: return 20;
            }
          }))
          .alphaDecay(0.02)  // åŠ é€Ÿæ¨¡æ‹Ÿæ”¶æ•›
          .velocityDecay(0.5);  // å‡å°‘æŠ–åŠ¨
        
        // æ›´æ–°ä½ç½®
        simulation.on('tick', () => {
          link
            .attr('x1', d => d.source.x)
            .attr('y1', d => d.source.y)
            .attr('x2', d => d.target.x)
            .attr('y2', d => d.target.y);
          
          node.attr('transform', d => `translate(${d.x},${d.y})`);
        });
        
        // åŠ›å¯¼å‘å¸ƒå±€ä¸‹çš„è¿æ¥çº¿åŠ¨ç”»
        setTimeout(() => {
          link.transition()
            .duration(1000)
            .attr('stroke-opacity', 0.6);
        }, 500);
      } else if (layoutType === 'circular') {
        // ç¯å½¢å¸ƒå±€
        const radius = Math.min(width, height) / 3;
        
        // è®¡ç®—èŠ‚ç‚¹ä½ç½®
        nodes.forEach((n, i) => {
          const angle = (i / nodes.length) * 2 * Math.PI;
          n.x = width / 2 + radius * Math.cos(angle);
          n.y = height / 2 + radius * Math.sin(angle);
        });
        
        // æ›´æ–°èŠ‚ç‚¹ä½ç½®
        node.transition()
          .duration(800)
          .attr('transform', d => `translate(${d.x},${d.y})`);
        
        // æ›´æ–°è¿æ¥çº¿ä½ç½®å¹¶æ·»åŠ åŠ¨ç”»
        link
          .attr('x1', d => d.source.x)
          .attr('y1', d => d.source.y)
          .attr('x2', d => d.target.x)
          .attr('y2', d => d.target.y)
          .transition()
          .duration(1000)
          .delay(300)
          .attr('stroke-opacity', 0.6);
      } else if (layoutType === 'radial') {
        // è¾å°„çŠ¶å¸ƒå±€
        const radius = Math.min(width, height) / 3;
        
        // å°†èŠ‚ç‚¹åˆ†ä¸ºä¸åŒå±‚çº§
        const centralNode = nodes.find(n => n.type === 'ä¸­å¿ƒä¸»é¢˜');
        const cultureNodes = nodes.filter(n => n.type === 'æ–‡åŒ–å†…æ¶µ');
        const ethnicNodes = nodes.filter(n => n.type === 'æ°‘æ—æ–‡åŒ–');
        
        // ä¸­å¿ƒèŠ‚ç‚¹ä½ç½®
        centralNode.x = width / 2;
        centralNode.y = height / 2;
        
        // æ–‡åŒ–å†…æ¶µèŠ‚ç‚¹ï¼ˆç¬¬äºŒåœˆï¼‰
        cultureNodes.forEach((n, i) => {
          const angle = (i / cultureNodes.length) * 2 * Math.PI;
          n.x = width / 2 + (radius / 2) * Math.cos(angle);
          n.y = height / 2 + (radius / 2) * Math.sin(angle);
        });
        
        // æ°‘æ—æ–‡åŒ–èŠ‚ç‚¹ï¼ˆç¬¬ä¸‰åœˆï¼‰
        ethnicNodes.forEach((n, i) => {
          const angle = (i / ethnicNodes.length) * 2 * Math.PI;
          n.x = width / 2 + radius * Math.cos(angle);
          n.y = height / 2 + radius * Math.sin(angle);
        });
        
        // æ›´æ–°èŠ‚ç‚¹ä½ç½®
        node.transition()
          .duration(800)
          .attr('transform', d => `translate(${d.x},${d.y})`);
        
        // æ›´æ–°è¿æ¥çº¿ä½ç½®å¹¶æ·»åŠ åŠ¨ç”»
        link
          .attr('x1', d => d.source.x)
          .attr('y1', d => d.source.y)
          .attr('x2', d => d.target.x)
          .attr('y2', d => d.target.y)
          .transition()
          .duration(1000)
          .delay(300)
          .attr('stroke-opacity', 0.6);
      } else if (layoutType === 'tree') {
        // æ ‘çŠ¶å¸ƒå±€
        const treeLayout = d3.tree()
          .size([height - 100, width - 100]);
        
        // æ„å»ºå±‚æ¬¡æ•°æ®ç»“æ„
        const root = d3.hierarchy({
          id: 'root',
          children: nodes.filter(n => n.type === 'ä¸­å¿ƒä¸»é¢˜').map(central => ({
            ...central,
            children: [
              ...nodes.filter(n => n.type === 'æ–‡åŒ–å†…æ¶µ').map(culture => ({
                ...culture,
                children: []
              })),
              ...nodes.filter(n => n.type === 'æ°‘æ—æ–‡åŒ–').map(ethnic => ({
                ...ethnic,
                children: []
              }))
            ]
          }))
        });
        
        // åº”ç”¨æ ‘çŠ¶å¸ƒå±€
        treeLayout(root);
        
        // æ›´æ–°èŠ‚ç‚¹ä½ç½®
        node.each(function(d) {
          const treeNode = root.find(n => n.data.id === d.id);
          if (treeNode) {
            d.x = treeNode.x;
            d.y = treeNode.y + 50;
          }
        });
        
        // æ›´æ–°èŠ‚ç‚¹ä½ç½®
        node.transition()
          .duration(800)
          .attr('transform', d => `translate(${d.y},${d.x})`);
        
        // æ›´æ–°è¿æ¥çº¿ä½ç½®å¹¶æ·»åŠ åŠ¨ç”»
        link
          .attr('x1', d => {
            const sourceNode = root.find(n => n.data.id === d.source.id);
            return sourceNode ? sourceNode.y + 50 : 0;
          })
          .attr('y1', d => {
            const sourceNode = root.find(n => n.data.id === d.source.id);
            return sourceNode ? sourceNode.x : 0;
          })
          .attr('x2', d => {
            const targetNode = root.find(n => n.data.id === d.target.id);
            return targetNode ? targetNode.y + 50 : 0;
          })
          .attr('y2', d => {
            const targetNode = root.find(n => n.data.id === d.target.id);
            return targetNode ? targetNode.x : 0;
          })
          .transition()
          .duration(1000)
          .delay(300)
          .attr('stroke-opacity', 0.6);
      }
      
      // ä¸ºæ‰€æœ‰å¸ƒå±€ç±»å‹æ·»åŠ è¿æ¥çº¿æ‚¬åœæ•ˆæœ
      link.on('mouseover', function() {
        d3.select(this)
          .transition()
          .duration(300)
          .attr('stroke-opacity', 1)
          .attr('stroke-width', 2.5);
      })
      .on('mouseout', function() {
        d3.select(this)
          .transition()
          .duration(300)
          .attr('stroke-opacity', 0.6)
          .attr('stroke-width', 1.5);
      });
      
      
      // æ·»åŠ CSSæ ·å¼
      const style = d3.select('head').select('style[data-tooltip]');
      if (!style.node()) {
        d3.select('head').append('style')
          .attr('data-tooltip', '')
          .html(`
            .tooltip {
              position: absolute;
              z-index: 1000;
              background: rgba(255, 255, 255, 0.95);
              border: 1px solid #ccc;
              border-radius: 8px;
              padding: 12px;
              box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
              font-family: 'Segoe UI', sans-serif;
              font-size: 14px;
              line-height: 1.5;
              max-width: 300px;
              overflow: auto;
              pointer-events: none;
            }
            
            .tooltip-content {
              display: flex;
              flex-direction: column;
              gap: 8px;
            }
            
            .tooltip-title {
              margin: 0 0 8px 0;
              padding-bottom: 8px;
              border-bottom: 1px solid #eee;
              font-size: 16px;
              color: #E74C3C;
            }
            
            .tooltip-section {
              margin: 0;
            }
            
            .tooltip strong {
              color: #2C3E50;
            }
          `);
      }
      
      // ç‚¹å‡»é«˜äº®å‡½æ•°
      function handleNodeClick(event, d) {
        // ç§»é™¤ä¹‹å‰çš„é«˜äº®
        node.select('circle').attr('r', d => {
          // æ ¹æ®èŠ‚ç‚¹ç±»å‹è°ƒæ•´å¤§å°
          switch (d.type) {
            case 'ä¸­å¿ƒä¸»é¢˜': return 25;
            case 'æ–‡åŒ–å†…æ¶µ': return 20;
            case 'æ°‘æ—æ–‡åŒ–': return 18;
            default: return 15;
          }
        }).attr('stroke-width', 1.5).classed('highlight', false);
        link.classed('highlight', false).attr('stroke-width', 1.5).attr('stroke-opacity', 0.6);
        
        // é«˜äº®å½“å‰èŠ‚ç‚¹
        d3.select(this).attr('r', d => {
          // æ ¹æ®èŠ‚ç‚¹ç±»å‹è°ƒæ•´é«˜äº®å¤§å°
          switch (d.type) {
            case 'ä¸­å¿ƒä¸»é¢˜': return 30;
            case 'æ–‡åŒ–å†…æ¶µ': return 25;
            case 'æ°‘æ—æ–‡åŒ–': return 23;
            default: return 20;
          }
        }).attr('stroke-width', 3).classed('highlight', true);
        
        // é«˜äº®ç›¸å…³èŠ‚ç‚¹å’Œè¿æ¥
        link.filter(l => l.source.id === d.id || l.target.id === d.id)
          .classed('highlight', true)
          .attr('stroke-width', 3)
          .attr('stroke-opacity', 1);
        
        node.filter(n => {
          return n.id === d.id || 
            links.some(l => l.source.id === d.id && l.target.id === n.id) ||
            links.some(l => l.target.id === d.id && l.source.id === n.id);
        })
        .select('circle')
        .attr('r', d => {
          // æ ¹æ®èŠ‚ç‚¹ç±»å‹è°ƒæ•´é«˜äº®å¤§å°
          switch (d.type) {
            case 'ä¸­å¿ƒä¸»é¢˜': return 30;
            case 'æ–‡åŒ–å†…æ¶µ': return 25;
            case 'æ°‘æ—æ–‡åŒ–': return 23;
            default: return 20;
          }
        })
        .attr('stroke-width', 3)
        .classed('highlight', true);
      }
      
      // æ‚¬åœæç¤ºå‡½æ•°
      function handleMouseOver(event, d) {
        // åˆ›å»ºæç¤ºæ¡†
        const tooltip = d3.select('body').append('div')
          .attr('class', 'tooltip')
          .style('left', `${event.pageX + 10}px`)
          .style('top', `${event.pageY - 10}px`)
          .style('opacity', 0);
        
        tooltip.transition()
          .duration(200)
          .style('opacity', 0.9);
        
        // è·å–ä¸å½“å‰èŠ‚ç‚¹ç›¸å…³çš„æ‰€æœ‰è¿æ¥
        const relatedLinks = links.filter(link => 
          link.source.id === d.id || link.target.id === d.id
        );
        
        // æ„å»ºå…³ç³»ä¿¡æ¯HTML
        let relationsHtml = '';
        if (relatedLinks.length > 0) {
          relationsHtml += '<br><strong>ç›¸å…³å…³ç³»:</strong><br>';
          relatedLinks.forEach(link => {
            // ç¡®å®šè¿æ¥çš„å¦ä¸€æ–¹èŠ‚ç‚¹
            const otherNode = link.source.id === d.id ? link.target : link.source;
            relationsHtml += `â€¢ ${link.relation} â†’ ${otherNode.name} (${otherNode.type})<br>`;
          });
        }
        
        tooltip.html(`
          <div class="tooltip-content">
            <h3 class="tooltip-title">${d.name}</h3>
            <div class="tooltip-section">
              <strong>ç±»å‹:</strong> ${d.type}
            </div>
            <div class="tooltip-section">
              <strong>æè¿°:</strong> ${d.description}
            </div>
            ${d.culture ? `<div class="tooltip-section"><strong>æ–‡åŒ–:</strong> ${d.culture}</div>` : ''}
            ${d.customs ? `<div class="tooltip-section"><strong>ä¹ ä¿—:</strong> ${d.customs}</div>` : ''}
            ${relationsHtml ? `<div class="tooltip-section">${relationsHtml}</div>` : ''}
          </div>
        `);
        
        // ä¿å­˜æç¤ºæ¡†å¼•ç”¨
        d.tooltip = tooltip;
      }
      
      function handleMouseOut(event, d) {
        // ç§»é™¤æç¤ºæ¡†
        if (d.tooltip) {
          d.tooltip.transition()
            .duration(500)
            .style('opacity', 0)
            .remove();
          delete d.tooltip;
        }
      }
      
      console.log('D3.jså›¾è°±æ¸²æŸ“æˆåŠŸ');
      
      // éšè—åŠ è½½å±‚
      if (loadingOverlay) {
        loadingOverlay.style.display = 'none';
      }
      
      // === æ–°å¢ï¼šæœç´¢åŠŸèƒ½ ===
      const searchInput = document.getElementById('graph-search');
      if (searchInput) {
        // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…é‡å¤ç»‘å®š
        searchInput.replaceWith(searchInput.cloneNode(true));
        
        // è·å–æ–°çš„æœç´¢æ¡†å…ƒç´ 
        const newSearchInput = document.getElementById('graph-search');
        
        newSearchInput.addEventListener('input', function() {
          const query = this.value.toLowerCase().trim();
          if (!query) {
            // æ¸…ç©ºæœç´¢ï¼šæ¢å¤æ‰€æœ‰èŠ‚ç‚¹
            node.selectAll("circle")
              .transition()
              .duration(500)
              .attr("r", d => {
                // æ ¹æ®èŠ‚ç‚¹ç±»å‹æ¢å¤åŸå§‹å¤§å°
                switch (d.type) {
                  case 'ä¸­å¿ƒä¸»é¢˜': return 25;
                  case 'æ–‡åŒ–å†…æ¶µ': return 20;
                  case 'æ°‘æ—æ–‡åŒ–': return 18;
                  default: return 15;
                }
              })
              .style("opacity", 1);
            return;
          }
  
          // æŸ¥æ‰¾åŒ¹é…èŠ‚ç‚¹ï¼ˆæ”¯æŒnameã€typeã€descriptionã€cultureã€customsï¼‰
          const matches = nodes.filter(node =>
            node.name.toLowerCase().includes(query) ||
            node.type.toLowerCase().includes(query) ||
            (node.description && node.description.toLowerCase().includes(query)) ||
            (node.culture && node.culture.toLowerCase().includes(query)) ||
            (node.customs && node.customs.toLowerCase().includes(query))
          );
  
          // é«˜äº®åŒ¹é…èŠ‚ç‚¹ + ä½äº®ä¸åŒ¹é…
          node.selectAll("circle")
            .transition()
            .duration(500)
            .attr("r", d => matches.some(m => m.id === d.id) ? {
              // æ ¹æ®èŠ‚ç‚¹ç±»å‹è°ƒæ•´é«˜äº®å¤§å°
              'ä¸­å¿ƒä¸»é¢˜': 30,
              'æ–‡åŒ–å†…æ¶µ': 25,
              'æ°‘æ—æ–‡åŒ–': 23,
              default: 20
            }[d.type] : {
              // æ ¹æ®èŠ‚ç‚¹ç±»å‹è°ƒæ•´åŸå§‹å¤§å°
              'ä¸­å¿ƒä¸»é¢˜': 25,
              'æ–‡åŒ–å†…æ¶µ': 20,
              'æ°‘æ—æ–‡åŒ–': 18,
              default: 15
            }[d.type])
            .style("opacity", d => matches.some(m => m.id === d.id) ? 1 : 0.2);
        });
      }
      
      // === æ–°å¢ï¼šèŠ‚ç‚¹è¯¦æƒ…æŸ¥çœ‹åŠŸèƒ½ ===
      // åˆ›å»ºè¯¦æƒ…æ¨¡æ€æ¡†å®¹å™¨
      let detailModal = document.getElementById('node-detail-modal');
      if (!detailModal) {
        detailModal = document.createElement('div');
        detailModal.id = 'node-detail-modal';
        detailModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300';
        detailModal.style.opacity = '0';
        detailModal.style.display = 'none';
        detailModal.innerHTML = `
          <div class="bg-white rounded-2xl shadow-xl max-w-2xl w-full mx-4 overflow-hidden transform transition-transform duration-300 scale-95">
            <div class="bg-[#E74C3C] p-4 flex justify-between items-center">
              <h3 class="text-white text-xl font-semibold">èŠ‚ç‚¹è¯¦æƒ…</h3>
              <button class="text-white text-2xl hover:text-gray-200 transition" onclick="this.closest('.fixed').style.display = 'none'" title="å…³é—­è¯¦æƒ…">&times;</button>
            </div>
            <div class="p-6" id="node-detail-content">
              <!-- èŠ‚ç‚¹è¯¦æƒ…å†…å®¹å°†åŠ¨æ€å¡«å…… -->
            </div>
            <div class="flex justify-end p-4 border-t">
              <button class="bg-[#3498DB] text-white px-6 py-2 rounded-lg hover:bg-[#2980B9] transition" onclick="this.closest('.fixed').style.display = 'none'">
                å…³é—­
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(detailModal);
      }
      
      // æ›´æ–°èŠ‚ç‚¹ç‚¹å‡»äº‹ä»¶ï¼Œæ·»åŠ è¯¦æƒ…æŸ¥çœ‹
      node.on('click', function(event, d) {
        // æ˜¾ç¤ºèŠ‚ç‚¹è¯¦æƒ…æ¨¡æ€æ¡†
        const contentDiv = detailModal.querySelector('#node-detail-content');
        contentDiv.innerHTML = `
          <div class="space-y-4">
            <div class="flex items-center">
              <div class="w-12 h-12 rounded-full mr-4" style="background-color: ${d.color}"></div>
              <div>
                <h4 class="text-2xl font-semibold text-[#E74C3C]">${d.name}</h4>
                <p class="text-gray-600">${d.type}</p>
              </div>
            </div>
            
            <div class="bg-gray-50 p-4 rounded-lg">
              <h5 class="font-medium text-[#2C3E50] mb-2">æè¿°</h5>
              <p class="text-gray-700">${d.description || 'æš‚æ— æè¿°'}</p>
            </div>
            
            ${d.culture ? `
              <div class="bg-gray-50 p-4 rounded-lg">
                <h5 class="font-medium text-[#2C3E50] mb-2">æ–‡åŒ–</h5>
                <p class="text-gray-700">${d.culture}</p>
              </div>
            ` : ''}
            
            ${d.customs ? `
              <div class="bg-gray-50 p-4 rounded-lg">
                <h5 class="font-medium text-[#2C3E50] mb-2">ä¹ ä¿—</h5>
                <p class="text-gray-700">${d.customs}</p>
              </div>
            ` : ''}
            
            <div class="bg-gray-50 p-4 rounded-lg">
              <h5 class="font-medium text-[#2C3E50] mb-2">ç›¸å…³è¿æ¥</h5>
              <ul class="space-y-2">
                ${links.filter(l => l.source.id === d.id || l.target.id === d.id).map(link => {
                  const otherNode = link.source.id === d.id ? link.target : link.source;
                  return `<li class="flex items-center">
                    <div class="w-3 h-3 rounded-full mr-2" style="background-color: ${otherNode.color}"></div>
                    <span>${otherNode.name}</span>
                    <span class="mx-2 text-gray-400">â†’</span>
                    <span class="text-gray-600">${link.relation}</span>
                  </li>`;
                }).join('')}
              </ul>
            </div>
          </div>
        `;
        
        detailModal.style.display = 'flex';
        setTimeout(() => {
          detailModal.style.opacity = '1';
          const modalContent = detailModal.querySelector('.bg-white');
          modalContent.classList.remove('scale-95');
          modalContent.classList.add('scale-100');
        }, 10);
      });
      
      // === æ–°å¢ï¼šå›¾è°±å¯¼å‡ºåŠŸèƒ½ ===
      const exportPdfBtn = document.getElementById('export-pdf');
      if (exportPdfBtn) {
        exportPdfBtn.addEventListener('click', function() {
          // ä½¿ç”¨html2canvaså’Œjspdfå®ç°å›¾è°±å¯¼å‡º
          if (typeof html2canvas === 'undefined') {
            // åŠ¨æ€åŠ è½½html2canvasåº“
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
            script.onload = function() {
              exportGraphAsPDF();
            };
            document.body.appendChild(script);
          } else {
            exportGraphAsPDF();
          }
        });
      }
      
      function exportGraphAsPDF() {
        const container = document.getElementById('graphContainer');
        html2canvas(container).then(canvas => {
          const imgData = canvas.toDataURL('image/png');
          const pdf = new jspdf.jsPDF({
            orientation: 'landscape',
            unit: 'mm',
            format: 'a4'
          });
          
          const pdfWidth = pdf.internal.pageSize.getWidth();
          const pdfHeight = pdf.internal.pageSize.getHeight();
          const imgWidth = canvas.width;
          const imgHeight = canvas.height;
          const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
          
          const imgX = (pdfWidth - imgWidth * ratio) / 2;
          const imgY = (pdfHeight - imgHeight * ratio) / 2;
          
          pdf.addImage(imgData, 'PNG', imgX, imgY, imgWidth * ratio, imgHeight * ratio);
          pdf.save(`æ–‡åŒ–çŸ¥è¯†å›¾è°±_${new Date().getTime()}.pdf`);
        });
      }
      
      // === æ–°å¢ï¼šå›¾è°±ä¿å­˜åŠŸèƒ½ ===
      const saveGraphBtn = document.getElementById('save-graph');
      if (saveGraphBtn) {
        saveGraphBtn.addEventListener('click', function() {
          // æ¨¡æ‹Ÿä¿å­˜åˆ°æ•°æ®åº“
          const graphData = {
            keyword: keyword,
            ethnic_group: selectedEthnicGroup,
            culture_type: selectedCultureType,
            aspect: selectedAspect,
            layout: layoutType,
            nodes: nodes,
            links: links,
            timestamp: new Date().toISOString()
          };
          
          // æ˜¾ç¤ºä¿å­˜æˆåŠŸæç¤º
          const successModal = document.createElement('div');
          successModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300';
          successModal.style.opacity = '0';
          successModal.innerHTML = `
            <div class="bg-white rounded-2xl shadow-xl max-w-md w-full mx-4 overflow-hidden transform transition-transform duration-300 scale-95">
              <div class="bg-[#27AE60] p-4 flex justify-between items-center">
                <h3 class="text-white text-xl font-semibold">ä¿å­˜æˆåŠŸ</h3>
                <button class="text-white text-2xl hover:text-gray-200 transition" onclick="this.closest('.fixed').remove()" title="å…³é—­æç¤º">&times;</button>
              </div>
              <div class="p-6 text-center">
                <div class="text-[#27AE60] text-6xl mb-4">
                  <span class="iconify" data-icon="mdi:check-circle" data-width="64"></span>
                </div>
                <h4 class="text-xl font-medium text-[#2C3E50] mb-2">å›¾è°±å·²æˆåŠŸä¿å­˜</h4>
                <p class="text-gray-600 mb-4">æ‚¨å¯ä»¥åœ¨ä¸ªäººä¸­å¿ƒæŸ¥çœ‹å’Œç®¡ç†å·²ä¿å­˜çš„å›¾è°±</p>
                <button class="bg-[#3498DB] text-white px-6 py-3 rounded-lg hover:bg-[#2980B9] transition w-full" onclick="this.closest('.fixed').remove()">
                  ç¡®å®š
                </button>
              </div>
            </div>
          `;
          document.body.appendChild(successModal);
          
          setTimeout(() => {
            successModal.style.opacity = '1';
            const modalContent = successModal.querySelector('.bg-white');
            modalContent.classList.remove('scale-95');
            modalContent.classList.add('scale-100');
          }, 10);
          
          setTimeout(() => {
            successModal.remove();
          }, 3000);
        });
      }
    } catch (error) {
      console.error('D3.jsæ¸²æŸ“å¤±è´¥:', error);
      showError('å›¾è°±æ¸²æŸ“å¤±è´¥', error.message);
      
      // éšè—åŠ è½½å±‚
      if (loadingOverlay) {
        loadingOverlay.style.display = 'none';
      }
      
      // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
      const container = document.getElementById('graphContainer');
      container.innerHTML = '<div class="flex items-center justify-center h-full text-gray-600">æ— æ³•æ¸²æŸ“å›¾è°±ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•</div>';
    }
  }

  // è¡¨å•æäº¤äº‹ä»¶å¤„ç†
  document.addEventListener('DOMContentLoaded', function() {
    // åˆå§‹æ¸²æŸ“
    renderGraph('èŒ¶', 'å…¨éƒ¨', 'å…¨éƒ¨', 'å…¨éƒ¨');
    
    // ç›‘å¬è¡¨å•æäº¤
    const form = document.querySelector('form[action="/culture/engine"]');
    if (form) {
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // è·å–è¡¨å•æ•°æ®
        const keyword = document.getElementById('keyword').value || 'èŒ¶';
        const ethnic_group = form.querySelector('select[name="ethnic_group"]').value;
        const culture_type = form.querySelector('select[name="culture_type"]').value;
        const aspect = form.querySelector('select[name="aspect"]').value;
        
        // æ›´æ–°å½“å‰é€‰ä¸­çš„å‚æ•°
        currentSelectedKeyword = keyword;
        currentSelectedEthnic = ethnic_group;
        currentSelectedCultureType = culture_type;
        currentSelectedAspect = aspect;
        
        // æ¸²æŸ“å›¾è°±
        await renderGraph(keyword, ethnic_group, culture_type, aspect);
      });
    }
  });
  
  // ä¿å­˜/å¯¼å‡ºåŠŸèƒ½
  document.getElementById('save-graph').addEventListener('click', function() {
    // ç®€å•çš„ä¿å­˜åŠŸèƒ½å®ç°
    alert('å›¾è°±ä¿å­˜åŠŸèƒ½å·²è§¦å‘');
  });
  
  document.getElementById('export-pdf').addEventListener('click', function() {
    // ç®€å•çš„å¯¼å‡ºPDFåŠŸèƒ½å®ç°
    alert('PDFå¯¼å‡ºåŠŸèƒ½å·²è§¦å‘');
  });
  
  // é‡ç½®è§†å›¾åŠŸèƒ½
  document.getElementById('reset-view').addEventListener('click', function() {
    // é‡æ–°æ¸²æŸ“å›¾è°±
    renderGraph(currentSelectedKeyword, currentSelectedEthnic, currentSelectedCultureType, currentSelectedAspect);
  });
  
  // å…¨å±åŠŸèƒ½
  document.getElementById('fullscreen').addEventListener('click', function() {
    const container = document.querySelector('.bg-white.rounded-2xl.shadow-xl.p-6');
    if (container.requestFullscreen) {
      container.requestFullscreen();
    } else if (container.mozRequestFullScreen) {
      container.mozRequestFullScreen();
    } else if (container.webkitRequestFullscreen) {
      container.webkitRequestFullscreen();
    } else if (container.msRequestFullscreen) {
      container.msRequestFullscreen();
    }
  });
  
  // æ¸…é™¤é«˜äº®åŠŸèƒ½
  document.getElementById('clear-highlight').addEventListener('click', function() {
    // è·å–æ‰€æœ‰èŠ‚ç‚¹å’Œè¿æ¥çº¿
    const nodeCircles = document.querySelectorAll('.node circle');
    const links = document.querySelectorAll('.link');
    
    // æ¢å¤èŠ‚ç‚¹å’Œè¿æ¥çº¿çš„åŸå§‹æ ·å¼
    nodeCircles.forEach(circle => {
      circle.setAttribute('r', 15);
      circle.setAttribute('stroke-width', 1.5);
      circle.classList.remove('highlight');
    });
    
    links.forEach(link => {
      link.setAttribute('stroke-width', 1.5);
      link.setAttribute('stroke-opacity', 0.6);
      link.classList.remove('highlight');
    });
  });
  
  // æœç´¢å»ºè®®åŠŸèƒ½ï¼ˆç®€åŒ–ç‰ˆï¼‰
  const keywordInput = document.getElementById('keyword');
  const suggestionsContainer = document.getElementById('search-suggestions');
  
  if (keywordInput && suggestionsContainer) {
    keywordInput.addEventListener('input', function() {
      const value = this.value;
      if (value.length > 1) {
        // ç®€å•çš„æœç´¢å»ºè®®
        const suggestions = ['èŒ¶', 'æ˜¥èŠ‚', 'ä¹¦æ³•', 'é™¶ç“·', 'ä¸ç»¸', 'ä¸­åŒ»è¯', 'ä¹å™¨', 'å»ºç­‘', 'æœé¥°', 'é¥®é£Ÿ'];
        const filteredSuggestions = suggestions.filter(item => item.includes(value));
        
        if (filteredSuggestions.length > 0) {
          suggestionsContainer.innerHTML = filteredSuggestions.map(item => `<div class="p-2 hover:bg-gray-100 cursor-pointer">${item}</div>`).join('');
          suggestionsContainer.classList.remove('hidden');
          
          // ç‚¹å‡»å»ºè®®é¡¹
          suggestionsContainer.querySelectorAll('div').forEach(item => {
            item.addEventListener('click', function() {
              keywordInput.value = this.textContent;
              suggestionsContainer.classList.add('hidden');
            });
          });
        } else {
          suggestionsContainer.classList.add('hidden');
        }
      } else {
        suggestionsContainer.classList.add('hidden');
      }
    });
    
    // ç‚¹å‡»å¤–éƒ¨å…³é—­å»ºè®®æ¡†
    document.addEventListener('click', function(e) {
      if (!keywordInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
        suggestionsContainer.classList.add('hidden');
      }
    });
  }
  
  // æ–‡åŒ–èåˆæµ·æŠ¥ç”Ÿæˆè¡¨å•å¤„ç†
  document.addEventListener('DOMContentLoaded', function() {
    // è·å–æ–‡åŒ–èåˆæµ·æŠ¥ç”Ÿæˆè¡¨å•
    const posterForm = document.querySelector('.bg-white.rounded-2xl.shadow-xl.p-6:nth-of-type(3) form');
    if (posterForm) {
      posterForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // è·å–è¡¨å•æ•°æ®
        const imageInput = document.getElementById('image');
        const posterTitle = document.getElementById('poster-title').value;
        const posterStyle = document.getElementById('poster-style').value;
        const posterText = document.getElementById('poster-text').value;
        
        if (!imageInput.files[0]) {
          showError('è¯·å…ˆä¸Šä¼ å›¾ç‰‡');
          return;
        }
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const submitBtn = posterForm.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="animate-spin mr-2">â³</span> ç”Ÿæˆä¸­...';
        submitBtn.disabled = true;
        
        try {
          // è¯»å–å›¾ç‰‡æ–‡ä»¶
          const reader = new FileReader();
          const imageDataUrl = await new Promise((resolve) => {
            reader.onload = (e) => resolve(e.target.result);
            reader.readAsDataURL(imageInput.files[0]);
          });
          
          // æ„å»ºè¯·æ±‚æ•°æ®
          const requestData = {
            image: imageDataUrl,
            title: posterTitle,
            style: posterStyle,
            text: posterText
          };
          
          // å‘é€è¯·æ±‚åˆ°AIç”ŸæˆAPI
          const response = await fetch('/api/culture/generate-poster', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
          });
          
          const result = await response.json();
          
          if (result.success) {
            // æ˜¾ç¤ºç”Ÿæˆç»“æœ
            showPosterResult(result.data);
          } else {
            showError('æµ·æŠ¥ç”Ÿæˆå¤±è´¥', result.message);
          }
        } catch (error) {
          console.error('æµ·æŠ¥ç”Ÿæˆé”™è¯¯:', error);
          showError('æµ·æŠ¥ç”Ÿæˆå¤±è´¥', error.message);
        } finally {
          // æ¢å¤æŒ‰é’®çŠ¶æ€
          submitBtn.innerHTML = originalBtnText;
          submitBtn.disabled = false;
        }
      });
    }
  });
  
  // æ˜¾ç¤ºæµ·æŠ¥ç”Ÿæˆç»“æœ
  function showPosterResult(result) {
    // åˆ›å»ºç»“æœæ¨¡æ€æ¡†
    const resultModal = document.createElement('div');
    resultModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300';
    resultModal.style.opacity = '0';
    resultModal.innerHTML = `
      <div class="bg-white rounded-2xl shadow-xl max-w-4xl w-full mx-4 overflow-hidden transform transition-transform duration-300 scale-95">
        <div class="bg-[#27AE60] p-4 flex justify-between items-center">
          <h3 class="text-white text-xl font-semibold">æµ·æŠ¥ç”ŸæˆæˆåŠŸ</h3>
          <button class="text-white text-2xl hover:text-gray-200 transition" onclick="this.closest('.fixed').style.display = 'none'" title="å…³é—­ç»“æœ">&times;</button>
        </div>
        <div class="p-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- ç”Ÿæˆçš„æµ·æŠ¥ -->
            <div>
              <h4 class="text-lg font-medium text-[#2C3E50] mb-4">ç”Ÿæˆç»“æœ</h4>
              <div class="bg-gray-50 p-4 rounded-lg">
                <img src="${result.generated_image || 'https://via.placeholder.com/500'}" class="w-full rounded-lg shadow-lg" alt="ç”Ÿæˆçš„æµ·æŠ¥">
              </div>
            </div>
            
            <!-- æµ·æŠ¥ä¿¡æ¯ -->
            <div>
              <h4 class="text-lg font-medium text-[#2C3E50] mb-4">æµ·æŠ¥ä¿¡æ¯</h4>
              <div class="space-y-4">
                <div>
                  <h5 class="text-sm font-medium text-gray-700">æ ‡é¢˜</h5>
                  <p class="text-gray-600">${result.title || 'æ— æ ‡é¢˜'}</p>
                </div>
                <div>
                  <h5 class="text-sm font-medium text-gray-700">é£æ ¼</h5>
                  <p class="text-gray-600">${result.style || 'ä¼ ç»Ÿé£æ ¼'}</p>
                </div>
                <div>
                  <h5 class="text-sm font-medium text-gray-700">å®£ä¼ è¯­</h5>
                  <p class="text-gray-600">${result.text || 'æ— å®£ä¼ è¯­'}</p>
                </div>
                <div>
                  <h5 class="text-sm font-medium text-gray-700">ç”Ÿæˆæ—¶é—´</h5>
                  <p class="text-gray-600">${new Date().toLocaleString()}</p>
                </div>
                
                <!-- æ“ä½œæŒ‰é’® -->
                <div class="pt-4 space-y-3">
                  <button class="w-full bg-[#3498DB] text-white py-3 rounded-lg hover:bg-[#2980B9] transition flex items-center justify-center" onclick="downloadPoster('${result.generated_image || ''}')">
                    <span class="iconify mr-2" data-icon="mdi:download"></span>
                    ä¸‹è½½æµ·æŠ¥
                  </button>
                  <button class="w-full bg-[#9B59B6] text-white py-3 rounded-lg hover:bg-[#8E44AD] transition flex items-center justify-center" onclick="sharePoster('${result.generated_image || ''}')">
                    <span class="iconify mr-2" data-icon="mdi:share-variant"></span>
                    åˆ†äº«æµ·æŠ¥
                  </button>
                  <button class="w-full bg-[#E74C3C] text-white py-3 rounded-lg hover:bg-[#C0392B] transition flex items-center justify-center" onclick="this.closest('.fixed').style.display = 'none'">
                    <span class="iconify mr-2" data-icon="mdi:close"></span>
                    å…³é—­
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(resultModal);
    
    setTimeout(() => {
      resultModal.style.opacity = '1';
      const modalContent = resultModal.querySelector('.bg-white');
      modalContent.classList.remove('scale-95');
      modalContent.classList.add('scale-100');
    }, 10);
  }
  
  // ä¸‹è½½æµ·æŠ¥
  function downloadPoster(imageUrl) {
    if (!imageUrl) {
      showError('æµ·æŠ¥å›¾ç‰‡ä¸å¯ç”¨');
      return;
    }
    
    const link = document.createElement('a');
    link.href = imageUrl;
    link.download = `æ–‡åŒ–èåˆæµ·æŠ¥_${new Date().getTime()}.png`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
  
  // åˆ†äº«æµ·æŠ¥
  function sharePoster(imageUrl) {
    if (!imageUrl) {
      showError('æµ·æŠ¥å›¾ç‰‡ä¸å¯ç”¨');
      return;
    }
    
    // æ˜¾ç¤ºåˆ†äº«é€‰é¡¹
    const shareModal = document.createElement('div');
    shareModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300';
    shareModal.style.opacity = '0';
    shareModal.innerHTML = `
      <div class="bg-white rounded-2xl shadow-xl max-w-md w-full mx-4 overflow-hidden transform transition-transform duration-300 scale-95">
        <div class="bg-[#3498DB] p-4 flex justify-between items-center">
          <h3 class="text-white text-xl font-semibold">åˆ†äº«æµ·æŠ¥</h3>
          <button class="text-white text-2xl hover:text-gray-200 transition" onclick="this.closest('.fixed').remove()" title="å…³é—­åˆ†äº«">&times;</button>
        </div>
        <div class="p-6">
          <div class="space-y-4">
            <div class="text-center">
              <h4 class="text-lg font-medium text-[#2C3E50] mb-2">é€‰æ‹©åˆ†äº«æ–¹å¼</h4>
              <p class="text-gray-600 mb-6">å°†ç”Ÿæˆçš„æ–‡åŒ–èåˆæµ·æŠ¥åˆ†äº«ç»™ä»–äºº</p>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
              <button class="bg-[#3B5998] text-white py-4 rounded-lg hover:bg-[#2D4373] transition flex flex-col items-center justify-center">
                <span class="text-3xl mb-2">ğŸ“˜</span>
                <span>å¾®ä¿¡</span>
              </button>
              <button class="bg-[#E4405F] text-white py-4 rounded-lg hover:bg-[#C13584] transition flex flex-col items-center justify-center">
                <span class="text-3xl mb-2">ğŸ“·</span>
                <span>å¾®ä¿¡æœ‹å‹åœˆ</span>
              </button>
              <button class="bg-[#1DA1F2] text-white py-4 rounded-lg hover:bg-[#0D95E8] transition flex flex-col items-center justify-center">
                <span class="text-3xl mb-2">ğŸ¦</span>
                <span>å¾®åš</span>
              </button>
              <button class="bg-[#FF0000] text-white py-4 rounded-lg hover:bg-[#CC0000] transition flex flex-col items-center justify-center">
                <span class="text-3xl mb-2">ğŸ“¹</span>
                <span>QQ</span>
              </button>
            </div>
            
            <!-- å¤åˆ¶é“¾æ¥ -->
            <div class="pt-4">
              <button class="w-full bg-[#27AE60] text-white py-3 rounded-lg hover:bg-[#229954] transition flex items-center justify-center" onclick="copyPosterLink('${imageUrl || ''}')">
                <span class="iconify mr-2" data-icon="mdi:link-variant"></span>
                å¤åˆ¶åˆ†äº«é“¾æ¥
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(shareModal);
    
    setTimeout(() => {
      shareModal.style.opacity = '1';
      const modalContent = shareModal.querySelector('.bg-white');
      modalContent.classList.remove('scale-95');
      modalContent.classList.add('scale-100');
    }, 10);
  }
  
  // å¤åˆ¶æµ·æŠ¥é“¾æ¥
  function copyPosterLink(imageUrl) {
    if (!imageUrl) {
      showError('æµ·æŠ¥é“¾æ¥ä¸å¯ç”¨');
      return;
    }
    
    // ç®€åŒ–å¤„ç†ï¼Œä½¿ç”¨å›¾ç‰‡URLä½œä¸ºåˆ†äº«é“¾æ¥
    navigator.clipboard.writeText(imageUrl).then(() => {
      // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
      const successToast = document.createElement('div');
      successToast.className = 'fixed top-4 right-4 bg-[#27AE60] text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full';
      successToast.innerHTML = `
        <div class="flex items-center">
          <span class="iconify mr-2" data-icon="mdi:check-circle"></span>
          <span>åˆ†äº«é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿</span>
        </div>
      `;
      document.body.appendChild(successToast);
      
      setTimeout(() => {
        successToast.classList.remove('translate-x-full');
      }, 10);
      
      setTimeout(() => {
        successToast.classList.add('translate-x-full');
        setTimeout(() => {
          successToast.remove();
        }, 300);
      }, 3000);
    }).catch(err => {
      showError('å¤åˆ¶é“¾æ¥å¤±è´¥', err.message);
    });
  }
</script>
{% endblock %}